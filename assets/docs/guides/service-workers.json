{"title":"Service Workers - Stencil","description":"Service Workers","url":"/docs/service-workers","contributors":["jthoms1","simonhaenisch","DavidFrahm","mrplastik001","adamdbradley"],"lastUpdated":"2020-12-17T18:36:37Z","headings":[{"id":"service-workers","level":1,"text":"Service Workers"},{"id":"what-is-workbox","level":2,"text":"What is Workbox?"},{"id":"usage","level":2,"text":"Usage"},{"id":"config","level":2,"text":"Config"},{"id":"disabling-the-service-worker","level":3,"text":"Disabling the service worker"},{"id":"using-a-custom-service-worker","level":2,"text":"Using a custom service worker"},{"id":"showing-a-reload-toast-when-an-update-is-available","level":3,"text":"Showing a reload toast when an update is available"},{"id":"handle-push-events","level":3,"text":"Handle push events"},{"id":"further-reading","level":3,"text":"Further Reading"}],"srcPath":"./src/docs/guides/service-workers.md","hypertext":["div",null,["h1",{"id":"service-workers"},"\n  \n  Service Workers\n  \n"],"\n",["p",null,["a",{"href":"https://developers.google.com/web/fundamentals/getting-started/primers/service-workers"},"Service workers"]," are a very powerful api that is essential for ",["a",{"href":"https://blog.ionic.io/what-is-a-progressive-web-app/"},"PWAs"],", but can be hard to use. To help with this, we decided to build support for Service Workers into Stencil itself using ",["a",{"href":"https://workboxjs.org/"},"Workbox"],"."],"\n\n",["h2",{"id":"what-is-workbox"},"\n  ",["a",{"class":"heading-link","href":"#what-is-workbox"},["app-icon",{"name":"link"}],"\n  What is Workbox?\n  "],"\n"],"\n",["p",null,"Workbox is a library that greatly simplifies the Service Worker API. It allows you to quickly generate a service worker that can handle caching static assets, cache remote assets using routes (similar to Express) or even do offline Google Analytics. Because we are built on top of Workbox, you can easily use any of the functionality they offer. For more info on Workbox, ",["a",{"href":"https://developers.google.com/web/tools/workbox/"},"check out their docs"]],"\n\n",["h2",{"id":"usage"},"\n  ",["a",{"class":"heading-link","href":"#usage"},["app-icon",{"name":"link"}],"\n  Usage\n  "],"\n"],"\n",["p",null,"When doing a production build of an app built using Stencil, the Stencil compiler will automatically generate a service worker for you and inject the necessary code to register the service worker in your index.html. Also, because the files Stencil generates are hashed, every time you do a production build and push an update to your app, the service worker will know to update, therefore ensuring your users are never stuck on a stale version of your site."],"\n",["p",null,"Lets run through the steps needed to enable service workers for your project:"],"\n",["ul",null,"\n",["li",null,["code",null,"cd"]," into your project"],"\n",["li",null,"Run ",["code",null,"npm run build"]],"\n"],"\n",["p",null,"And that's it! You should now have an ",["code",null,"sw.js"]," file in your ",["code",null,"www"]," folder and the code to register the service worker in your ",["code",null,"www/index.html"]," file."],"\n",["blockquote",null,"\n",["p",null,"The component starter by default does not have service workers enabled as a service worker is not needed for component collections"],"\n"],"\n\n",["h2",{"id":"config"},"\n  ",["a",{"class":"heading-link","href":"#config"},["app-icon",{"name":"link"}],"\n  Config\n  "],"\n"],"\n",["p",null,"Stencil uses Workbox underneath, and by default generates a service worker from a config object using the ",["code",null,"generateSW"]," mode. Therefore it supports all of the ",["a",{"href":"https://developers.google.com/web/tools/workbox/modules/workbox-build#full_generatesw_config"},"Workbox generateSW config options"],". Here is the default config Stencil uses:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token punctuation"},"{"],"\n  globPatterns",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n    ",["span",{"class":"token string"},"'**/*.{js,css,json,html}'"],"\n  ",["span",{"class":"token punctuation"},"]"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"This configuration does pre-caching of all of your app's assets."],"\n",["p",null,"To modify this config you can use the ",["code",null,"serviceWorker"]," param of your Stencil config. Here is an example:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Config ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," config",["span",{"class":"token operator"},":"]," Config ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"{"],"\n  outputTargets",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n    ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token keyword"},"type"],["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'www'"],["span",{"class":"token punctuation"},","],"\n      serviceWorker",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"{"],"\n        globPatterns",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n          ",["span",{"class":"token string"},"'**/*.{js,css,json,html,ico,png}'"],"\n        ",["span",{"class":"token punctuation"},"]"],"\n      ",["span",{"class":"token punctuation"},"}"],"\n    ",["span",{"class":"token punctuation"},"}"],"\n  ",["span",{"class":"token punctuation"},"]"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  \n",["h3",{"id":"disabling-the-service-worker"},"\n  ",["a",{"class":"heading-link","href":"#disabling-the-service-worker"},["app-icon",{"name":"link"}],"\n  Disabling the service worker\n  "],"\n"],"\n",["p",null,"If you do not want a service worker to be generated during the build, this can be turned off. To disable this feature, set the ",["code",null,"serviceWorker"]," property to ",["code",null,"null"]," in the ",["code",null,"www"]," output target."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Config ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," config",["span",{"class":"token operator"},":"]," Config ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"{"],"\n  outputTargets",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n    ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token keyword"},"type"],["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'www'"],["span",{"class":"token punctuation"},","],"\n      serviceWorker",["span",{"class":"token operator"},":"]," ",["span",{"class":"token keyword"},"null"],"\n    ",["span",{"class":"token punctuation"},"}"],"\n  ",["span",{"class":"token punctuation"},"]"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  \n",["h2",{"id":"using-a-custom-service-worker"},"\n  ",["a",{"class":"heading-link","href":"#using-a-custom-service-worker"},["app-icon",{"name":"link"}],"\n  Using a custom service worker\n  "],"\n"],"\n",["p",null,"Already have a service worker or want to include some custom code? We support that, too. By specifying a source file for your service worker, Stencil switches to the ",["code",null,"injectManifest"]," mode of Workbox. That gives you full control over your service worker, while still allowing you to automatically inject a precache manifest."],"\n",["p",null,"Let's go through the steps needed for this functionality:"],"\n",["ul",null,"\n",["li",null,"First we need to pass the path to our custom service worker to the ",["code",null,"swSrc"]," command in the ",["code",null,"serviceWorker"]," config. Here is an example:"],"\n"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Config ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," config",["span",{"class":"token operator"},":"]," Config ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"{"],"\n  outputTargets",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n    ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token keyword"},"type"],["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'www'"],["span",{"class":"token punctuation"},","],"\n      serviceWorker",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"{"],"\n        swSrc",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'src/sw.js'"],"\n      ",["span",{"class":"token punctuation"},"}"],"\n    ",["span",{"class":"token punctuation"},"}"],"\n  ",["span",{"class":"token punctuation"},"]"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["ul",null,"\n",["li",null,"Now we need to include some boilerplate code in our custom service worker:"],"\n"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token comment"},"// change to the version you get from `npm ls workbox-build`"],"\n",["span",{"class":"token function"},"importScripts"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'workbox-v4.3.1/workbox-sw.js'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token comment"},"// your custom service worker code"],"\n\n",["span",{"class":"token comment"},"// the precache manifest will be injected into the following line"],"\nself",["span",{"class":"token punctuation"},"."],"workbox",["span",{"class":"token punctuation"},"."],"precaching",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"precacheAndRoute"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"["],["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"This code imports the Workbox library, creates a new instance of the service worker and tells Workbox where to insert the pre-cache array."],"\n\n",["h3",{"id":"showing-a-reload-toast-when-an-update-is-available"},"\n  ",["a",{"class":"heading-link","href":"#showing-a-reload-toast-when-an-update-is-available"},["app-icon",{"name":"link"}],"\n  Showing a reload toast when an update is available\n  "],"\n"],"\n",["p",null,"When a new service worker is available, by default, it will be downloaded and then go into a state of waiting to be activated. The new service worker won't take over until all tabs of the site are closed and the site is visited again. This is to avoid unexpected behavior from conflicts with files being served from cache, and works well in many cases."],"\n",["p",null,"If you want to give your users the option to immediately access the new update, a common way is to show them a toast that lets them know about the update and offers a \"reload\" button. The reload let's the new service worker take over, serving the fresh content, and triggers a page reload, to avoid cache issues."],"\n",["p",null,"The following example showcases this in combination with the Ionic framework, but the toast-related code should be easily adaptable to any UI. Add the following to your root component (commonly ",["code",null,"app-root.tsx"],")."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"@",["span",{"class":"token function"},"Listen"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"\"swUpdate\""],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"{"]," target",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'window'"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],"\n",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token function"},"onServiceWorkerUpdate"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"const"]," registration ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," navigator",["span",{"class":"token punctuation"},"."],"serviceWorker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"getRegistration"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token operator"},"!"],"registration",["span",{"class":"token operator"},"?."],"waiting",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// If there is no waiting registration, this is the first service"],"\n    ",["span",{"class":"token comment"},"// worker being installed."],"\n    ",["span",{"class":"token keyword"},"return"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n\n  ",["span",{"class":"token keyword"},"const"]," toast ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," toastController",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"create"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n    message",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"\"New version available.\""],["span",{"class":"token punctuation"},","],"\n    buttons",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],["span",{"class":"token punctuation"},"{"]," text",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'Reload'"],["span",{"class":"token punctuation"},","]," role",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'reload'"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},","],"\n    duration",["span",{"class":"token operator"},":"]," ",["span",{"class":"token number"},"0"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"await"]," toast",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"present"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"const"]," ",["span",{"class":"token punctuation"},"{"]," role ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," toast",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"onWillDismiss"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],"role ",["span",{"class":"token operator"},"==="]," ",["span",{"class":"token string"},"'reload'"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    registration",["span",{"class":"token punctuation"},"."],"waiting",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"postMessage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"\"skipWaiting\""],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"The ",["code",null,"swUpdate"]," event is emitted by Stencil every time a new service worker is installed. When a service worker is waiting for registration, the toast is shown. After clicking the reload button, a message is posted to the waiting service worker, letting it know to take over. This message needs to be handled by the service worker; therefore we need to create a custome one (e. g. ",["code",null,"src/sw.js"],") and add a listener to call ",["code",null,"skipWaiting()"],"."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token function"},"importScripts"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"\"workbox-v4.3.1/workbox-sw.js\""],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\nself",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"addEventListener"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"\"message\""],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},["span",{"class":"token punctuation"},"{"]," data ",["span",{"class":"token punctuation"},"}"]],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],"data ",["span",{"class":"token operator"},"==="]," ",["span",{"class":"token string"},"\"skipWaiting\""],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    self",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"skipWaiting"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\nself",["span",{"class":"token punctuation"},"."],"workbox",["span",{"class":"token punctuation"},"."],"precaching",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"precacheAndRoute"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"["],["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["blockquote",null,"\n",["p",null,"Don't forget to set ",["code",null,"swSrc"]," in your Stencil config."],"\n"],"\n",["p",null,"Finally, we want our app to reload when the new service worker has taken over, so that no outdated code is served from the cache anymore. We can use the service worker's ",["code",null,"controllerchange"]," event for that, by attaching an event listener in our root component's ",["code",null,"componentWillLoad"]," lifecycle hook."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token function"},"componentWillLoad"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'serviceWorker'"]," ",["span",{"class":"token keyword"},"in"]," navigator",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    navigator",["span",{"class":"token punctuation"},"."],"serviceWorker\n      ",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"getRegistration"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],"\n      ",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"then"],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"registration"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n        ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],"registration",["span",{"class":"token operator"},"?."],"active",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n          navigator",["span",{"class":"token punctuation"},"."],"serviceWorker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"addEventListener"],["span",{"class":"token punctuation"},"("],"\n            ",["span",{"class":"token string"},"'controllerchange'"],["span",{"class":"token punctuation"},","],"\n            ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," window",["span",{"class":"token punctuation"},"."],"location",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"reload"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],"\n          ",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n        ",["span",{"class":"token punctuation"},"}"],"\n      ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  \n",["h3",{"id":"handle-push-events"},"\n  ",["a",{"class":"heading-link","href":"#handle-push-events"},["app-icon",{"name":"link"}],"\n  Handle push events\n  "],"\n"],"\n",["p",null,"A common use case for custom service workers is to handle browser push notifications. But before we will be able show push notifications, we first need to use the Notifications API to request permissions from the user to do so."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'Notification'"]," ",["span",{"class":"token keyword"},"in"]," window ",["span",{"class":"token operator"},"&&"]," ",["span",{"class":"token string"},"'serviceWorker'"]," ",["span",{"class":"token keyword"},"in"]," navigator",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n  Notification",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"requestPermission"],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"status"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// status will either be 'default', 'granted' or 'denied'"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"Notification permissions have been "],["span",{"class":"token interpolation"},["span",{"class":"token interpolation-punctuation punctuation"},"${"],"status",["span",{"class":"token interpolation-punctuation punctuation"},"}"]],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"The current permission status can always be checked using ",["code",null,"Notification.permission"],"."],"\n",["p",null,"To show a notification to the user after being granted permission, we can use the ",["code",null,"showNotification"]," method of our service worker's registration (within our custom service worker)."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"self",["span",{"class":"token punctuation"},"."],"registration",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"showNotification"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'Hakuna matata.'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"Usually we will have a backend that will send out push notifications to clients, and we want our service worker to handle them. To do that, we can register an event listener in our worker for the ",["code",null,"push"]," event. The event will be of type ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/PushEvent"},["code",null,"PushEvent"]]," and have a ",["code",null,"data"]," field of type ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/PushMessageData"},["code",null,"PushMessageData"]],"."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"self",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"addEventListener"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'push'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token parameter"},"event"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"Push received with data \""],["span",{"class":"token interpolation"},["span",{"class":"token interpolation-punctuation punctuation"},"${"],"event",["span",{"class":"token punctuation"},"."],"data",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"text"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token interpolation-punctuation punctuation"},"}"]],["span",{"class":"token string"},"\""],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"const"]," title ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token string"},"'Push Notification'"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token keyword"},"const"]," options ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"{"],"\n    body",["span",{"class":"token operator"},":"]," ",["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token interpolation"},["span",{"class":"token interpolation-punctuation punctuation"},"${"],"event",["span",{"class":"token punctuation"},"."],"data",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"text"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token interpolation-punctuation punctuation"},"}"]],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},","],"\n    data",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"{"]," href",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'/users/donald'"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},","],"\n    actions",["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"["],"\n      ",["span",{"class":"token punctuation"},"{"]," action",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'details'"],["span",{"class":"token punctuation"},","]," title",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'Details'"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},","],"\n      ",["span",{"class":"token punctuation"},"{"]," action",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'dismiss'"],["span",{"class":"token punctuation"},","]," title",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'Dismiss'"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},","],"\n    ",["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},","],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"],"\n\n  event",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"waitUntil"],["span",{"class":"token punctuation"},"("],"self",["span",{"class":"token punctuation"},"."],"registration",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"showNotification"],["span",{"class":"token punctuation"},"("],"title",["span",{"class":"token punctuation"},","]," options",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"If the data is a JSON string, then ",["code",null,"data.json()"]," can be used to immediately get the parsed data. The ",["code",null,"event.waitUntil"]," method is used to ensure that the service worker doesn't terminate before the asynchronous ",["code",null,"showNotification"]," operation has completed."],"\n",["p",null,"Furthermore, we will likely want to handle notification clicks. The API provides the events ",["code",null,"notificationclick"]," and ",["code",null,"notificationclose"]," for that."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"self",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"addEventListener"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'notificationclick'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token parameter"},"event"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"const"]," notification ",["span",{"class":"token operator"},"="]," event",["span",{"class":"token punctuation"},"."],"notification",["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token keyword"},"const"]," action ",["span",{"class":"token operator"},"="]," event",["span",{"class":"token punctuation"},"."],"action",["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],"action ",["span",{"class":"token operator"},"==="]," ",["span",{"class":"token string"},"'dismiss'"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    notification",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"close"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"else"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// This handles both notification click and 'details' action,"],"\n    ",["span",{"class":"token comment"},"// because some platforms might not support actions."],"\n    clients",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"openWindow"],["span",{"class":"token punctuation"},"("],"notification",["span",{"class":"token punctuation"},"."],"data",["span",{"class":"token punctuation"},"."],"href",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    notification",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"close"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"Now our service worker is able to receive and process push notifications, however we still need to register the client with our backend. Browsers provide a push service for that reason, which your app can subscribe to. The subscription object contains an endpoint URL with a unique identifier for each client. You can send your notifications to that URL, encrypted with a public key which is also provided by the subscription object."],"\n",["p",null,"In order to implement this, we first need to get each client to subscribe to the browser's push service, and then send the subscription object to our backend. Then our backend can generate the push notifications, encrypt them with the public key, and send them to the subscription endpoint URL."],"\n",["p",null,"First we will implement a function to subscribe the user to the push service, which as a best practice should be triggered from a user action signalling that they would like to receive push notifications. Assuming that notification permissions have already been granted, the following function can be used for that."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token keyword"},"function"]," ",["span",{"class":"token function"},"subscribeUser"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'serviceWorker'"]," ",["span",{"class":"token keyword"},"in"]," navigator",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," registration ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," navigator",["span",{"class":"token punctuation"},"."],"serviceWorker",["span",{"class":"token punctuation"},"."],"ready",["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token keyword"},"const"]," subscription ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," registration",["span",{"class":"token punctuation"},"."],"pushManager\n      ",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"subscribe"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"]," userVisibleOnly",["span",{"class":"token operator"},":"]," ",["span",{"class":"token boolean"},"true"]," ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],"\n      ",["span",{"class":"token punctuation"},"."],["span",{"class":"token keyword"},"catch"],["span",{"class":"token punctuation"},"("],["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],"error",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token operator"},"!"],"subscription",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token keyword"},"return"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token punctuation"},"}"],"\n\n    ",["span",{"class":"token comment"},"// the subscription object is what we want to send to our backend"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],"subscription",["span",{"class":"token punctuation"},"."],"endpoint",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"We should also check our subscription every time our app is accessed, because the subscription object can change."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"self",["span",{"class":"token punctuation"},"."],"registration",["span",{"class":"token punctuation"},"."],"pushManager",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"getSubscription"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"then"],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"subscription"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token operator"},"!"],"subscription",["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// ask the user to register for push"],"\n    ",["span",{"class":"token keyword"},"return"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n\n  ",["span",{"class":"token comment"},"// update the database"],"\n  ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],"subscription",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  \n",["h3",{"id":"further-reading"},"\n  ",["a",{"class":"heading-link","href":"#further-reading"},["app-icon",{"name":"link"}],"\n  Further Reading\n  "],"\n"],"\n",["ul",null,"\n",["li",null,"For more information on push notifications and the related APIs please refer to the ",["a",{"href":"https://developers.google.com/web/ilt/pwa/introduction-to-push-notifications"},"Web Fundamentals Introduction to Push Notifications"]," and the ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Push_API"},"MDN Push API docs"],"."],"\n",["li",null,["a",{"href":"https://twitter.com/davidbrunelle/status/1073394572980453376"},"This Twitter thread by David Brunelle"]," explains how to implement versioning in your PWA in order to handle breaking API changes. The problem here is that your service worker enabled app will continue to serve an outdated (cached) app against your updated API. In order to solve this a version check can be implemented."],"\n"]]}