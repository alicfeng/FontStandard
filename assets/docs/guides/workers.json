{"title":"Web Workers - Stencil","description":"Web Workers","url":"/docs/web-workers","lastUpdated":"2020-04-01T17:27:17Z","contributors":["manucorporat","liester","chrisdmacrae","adamdbradley"],"headings":[{"id":"web-workers","level":1,"text":"Web Workers"},{"id":"when-to-use-web-workers","level":2,"text":"When to use Web Workers?"},{"id":"best-practices-when-using-web-workers","level":2,"text":"Best Practices when using Web Workers"},{"id":"how-vanilla-web-workers-work","level":2,"text":"How vanilla Web Workers &quot;work&quot;?"},{"id":"web-workers-with-stencil","level":2,"text":"Web Workers with Stencil"},{"id":"imports-within-a-worker","level":3,"text":"Imports within a worker"},{"id":"dynamic-imports","level":4,"text":"Dynamic imports"},{"id":"worker-callbacks","level":3,"text":"Worker Callbacks"},{"id":"advanced-cases","level":2,"text":"Advanced cases"},{"id":"worker-termination","level":4,"text":"Worker Termination"}],"srcPath":"./src/docs/guides/workers.md","hypertext":["div",null,["h1",{"id":"web-workers"},"\n  \n  Web Workers\n  \n"],"\n",["p",null,["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"},"Web Workers"]," are a widely supported technology (Chrome, Firefox, Safari, Edge and IE11) that allows JavaScript to execute in a different thread, maximizing the usage of multiple CPUs; but most importantly not blocking the ",["strong",null,"main thread"],"."],"\n",["p",null,"The ",["strong",null,"main thread"]," is where Javascript runs by default and has access to the ",["code",null,"document"],", ",["code",null,"window"]," and other DOM APIs. The problem is that long-running JS prevents the browser from running smooth animations (CSS animations, transitions, canvas, svg...), making your site look frozen. That's why if your application needs to run CPU-intensive tasks, Web Workers are a great help."],"\n\n",["h2",{"id":"when-to-use-web-workers"},"\n  ",["a",{"class":"heading-link","href":"#when-to-use-web-workers"},["app-icon",{"name":"link"}],"\n  When to use Web Workers?\n  "],"\n"],"\n",["p",null,"The first thing to understand is when to use a Web Workers, and when ",["em",null,"not"]," to use them since they come with a set of costs and limitations:"],"\n",["ul",null,"\n",["li",null,"There is no access to the ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction"},"DOM"],". This means you cannot interact with ",["code",null,"document"],", ",["code",null,"window"]," or any elements in the page."],"\n",["li",null,"There is no access to any of the ",["code",null,"@stencil/core"]," APIs. For example, you cannot declare and use a component in a Web Worker, for the same reasons there is ",["strong",null,"no access to the DOM"],"."],"\n",["li",null,"A Web Worker has its own ",["strong",null,"isolated state"]," since each worker has their own memory space. For example, a variable declared on the main thread cannot be directly referenced from a worker."],"\n",["li",null,"There is an overhead when passing data between workers and the main thread. As a general rule, it's best to minimize the amount of data sent to and from the worker and be mindful if the work to send your data takes more time than doing it on the main thread."],"\n",["li",null,"Communication is always ",["strong",null,"asynchronous"],". Luckily Promises and async/await makes this relatively easy, but it's important to understand that communication between threads is always asynchronous."],"\n",["li",null,"You can ",["strong",null,"only"]," pass ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Primitive_values"},"primitives"]," and objects that implement the ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm"},"structured clone algorithm"],". Best way to think of it is any data that can be serialized to JSON is safe to use."],"\n"],"\n",["p",null,"In short, it's generally a good idea to use workers to move logic that is thread-blocking -- or UI-blocking, preventing users from interacting with the page -- into a Web Worker, such as real-time code syntax highlighting."],"\n\n",["h2",{"id":"best-practices-when-using-web-workers"},"\n  ",["a",{"class":"heading-link","href":"#best-practices-when-using-web-workers"},["app-icon",{"name":"link"}],"\n  Best Practices when using Web Workers\n  "],"\n"],"\n",["ul",null,"\n",["li",null,"Use pure and functional algorithms in workers. ",["code",null,"(input1, input2) => output"],"."],"\n",["li",null,"The worker logic itself can be as complex as it has to be, however, the input and output data should stay fairly simple."],"\n",["li",null,"Look for ways to reduce passing data between the main thread and worker thread."],"\n",["li",null,"Class instances cannot be passed as data. Instead, only work with data can be JSON serializable."],"\n",["li",null,"Minimize state within the worker, or better yet, completely avoid maintaining any state (e.g., don't put redux inside a worker)."],"\n",["li",null,"The cost of a worker should be easily amortized because it would be doing some CPU-intensive jobs."],"\n"],"\n\n",["h2",{"id":"how-vanilla-web-workers-work"},"\n  ",["a",{"class":"heading-link","href":"#how-vanilla-web-workers-work"},["app-icon",{"name":"link"}],"\n  How vanilla Web Workers \"work\"?\n  "],"\n"],"\n",["p",null,"The browser comes with a ",["code",null,"Worker"]," API, that works the following way:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"const"]," worker ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'/my-worker.js'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\nworker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"postMessage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"["],["span",{"class":"token string"},"'send message to worker'"],["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\nworker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function-variable function"},"onmessage"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"ev"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'data from worker'"],["span",{"class":"token punctuation"},","]," ev",["span",{"class":"token punctuation"},"."],"data",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"This API, while powerful, is very low level and makes it tedious to write complex apps, since the event-driven paradigm leads easily to ",["a",{"href":"https://en.wikipedia.org/wiki/Spaghetti_code"},"spaghetti-code"],", and quickly misses out on strongly-typed functions and data."],"\n",["p",null,"For further information, check out ",["a",{"href":"https://www.html5rocks.com/en/tutorials/workers/basics/"},"this fantastic tutorial"]," by our friends at HTML5Rocks."],"\n",["p",null,"A Web Worker also requires the generation of a separate JavaScript bundle, such as the ",["code",null,"my-worker.js"]," file in the example above. This means you usually need extra build scripts and tooling that transpiles and bundles the worker entry point into another ",["code",null,".js"]," file. Additionally, the main bundle must be able to reference the worker bundle's file location, which is oftentimes a challenge after transpiling, bundling, minifying, filename hashing and deploying to production servers."],"\n",["p",null,"Fortunately, Stencil can help you solve these two problems:"],"\n",["ul",null,"\n",["li",null,"Tooling: Transpiling, bundling, hashing, worker url path referencing"],"\n",["li",null,"Communication: Converting event-based communication to Promises, while still maintaining types."],"\n"],"\n\n",["h2",{"id":"web-workers-with-stencil"},"\n  ",["a",{"class":"heading-link","href":"#web-workers-with-stencil"},["app-icon",{"name":"link"}],"\n  Web Workers with Stencil\n  "],"\n"],"\n",["p",null,"As we already mention, Stencil's compiler can help you to use workers in production seamlessly. Any TypeScript file within the ",["code",null,"src"]," directory that ends with ",["code",null,".worker.ts"]," will automatically use a worker. For example:"],"\n",["p",null,["strong",null,"src/stuff.worker.ts:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},"\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," ",["span",{"class":"token function-variable function"},"sum"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"a",["span",{"class":"token operator"},":"]," number",["span",{"class":"token punctuation"},","]," b",["span",{"class":"token operator"},":"]," number"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"return"]," a ",["span",{"class":"token operator"},"+"]," b",["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],"\n\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," ",["span",{"class":"token function-variable function"},"expensiveTask"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"buffer",["span",{"class":"token operator"},":"]," ArrayBuffer"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"for"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token keyword"},"let"]," i ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token number"},"0"],["span",{"class":"token punctuation"},";"]," i ",["span",{"class":"token operator"},"<"]," buffer",["span",{"class":"token punctuation"},"."],"length",["span",{"class":"token punctuation"},";"]," i",["span",{"class":"token operator"},"++"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// do a lot of processing"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n  ",["span",{"class":"token keyword"},"return"]," buffer",["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,["strong",null,"src/my-app/my-app.tsx:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Component ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token comment"},"// Import the worker directly."],"\n",["span",{"class":"token comment"},"// Stencil will automatically create"],"\n",["span",{"class":"token comment"},"// a proxy and run the module in a worker."],"\n",["span",{"class":"token comment"},"// IDEs and TypeScript will treat this import"],"\n",["span",{"class":"token comment"},"// no differently than any other ESM import."],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," sum",["span",{"class":"token punctuation"},","]," expensiveTask ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../../stuff.worker'"],["span",{"class":"token punctuation"},";"],"\n\n@",["span",{"class":"token function"},"Component"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n  tag",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'my-cmp'"],"\n",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"class"]," ",["span",{"class":"token class-name"},"MyApp"]," ",["span",{"class":"token punctuation"},"{"],"\n\n  ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token function"},"componentWillLoad"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// sum() will run inside a worker! and the result is a Promise<number>"],"\n    ",["span",{"class":"token keyword"},"const"]," result ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"sum"],["span",{"class":"token punctuation"},"("],["span",{"class":"token number"},"1"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token number"},"2"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],"result",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]," ",["span",{"class":"token comment"},"// 3"],"\n\n    ",["span",{"class":"token comment"},"// expensiveTask() will not block the main thread,"],"\n    ",["span",{"class":"token comment"},"// because it runs in parallel inside the worker."],"\n    ",["span",{"class":"token comment"},"// Note that the functions must be async."],"\n    ",["span",{"class":"token keyword"},"const"]," newBuffer ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"expensiveTask"],["span",{"class":"token punctuation"},"("],"buffer",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],"newBuffer",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"Under the hood, Stencil compiles a worker file and uses the standard ",["code",null,"new Worker()"]," API to instantiate the worker. Then it creates proxies for each of the exported functions, so developers can interact with it using ",["a",{"href":"https://en.wikipedia.org/wiki/Structured_programming"},"structured programming constructs"]," instead of event-based ones."],"\n",["blockquote",null,"\n",["p",null,"Workers are already placed in a different chunk, and dynamically loaded using ",["code",null,"new Worker()"],". You should avoid using a dynamic ",["code",null,"import()"]," to load them, as this will cause two network requests. Instead, use ES module imports as it's only importing the proxies for communicating with the worker."],"\n"],"\n\n",["h3",{"id":"imports-within-a-worker"},"\n  ",["a",{"class":"heading-link","href":"#imports-within-a-worker"},["app-icon",{"name":"link"}],"\n  Imports within a worker\n  "],"\n"],"\n",["p",null,"Normal ",["code",null,"ESM"]," imports are possible when building workers in Stencil. Under the hood, the compiler bundles all the dependencies of a worker into a single file that becomes the worker's entry-point, a dependency-free file that can run without problems."],"\n",["p",null,["strong",null,"src/loader.worker.ts:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," upngjs ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'upng-js'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Images ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'./materials'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," ",["span",{"class":"token function-variable function"},"loadTexture"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"imagesSrcs",["span",{"class":"token operator"},":"]," Images"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"const"]," images ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token builtin"},"Promise"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"all"],["span",{"class":"token punctuation"},"("],"\n    imagesSrcs",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"map"],["span",{"class":"token punctuation"},"("],"loadOriginalImage",["span",{"class":"token punctuation"},")"],"\n  ",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token keyword"},"return"]," images",["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],"\n\n",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token keyword"},"function"]," ",["span",{"class":"token function"},"loadOriginalImage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"src",["span",{"class":"token operator"},":"]," string"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"const"]," res ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"fetch"],["span",{"class":"token punctuation"},"("],"src",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token keyword"},"const"]," png ",["span",{"class":"token operator"},"="]," upngjs",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"decode"],["span",{"class":"token punctuation"},"("],["span",{"class":"token keyword"},"await"]," res",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"arrayBuffer"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token keyword"},"return"]," png",["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"In this example, we are building a worker called ",["code",null,"loader.worker.ts"]," that imports an NPM dependency (",["code",null,"upngjs"],", used to parse png files), and a local module (",["code",null,"./materials"],"). Stencil will use ",["a",{"href":"https://rollupjs.org/guide/en/"},"Rollup"]," to bundle all dependencies and remove all imports at runtime. Be aware that code will be duplicated if imported inside and outside a worker."],"\n\n",["h4",{"id":"dynamic-imports"},"\n  ",["a",{"class":"heading-link","href":"#dynamic-imports"},["app-icon",{"name":"link"}],"\n  Dynamic imports\n  "],"\n"],"\n",["p",null,"In order to load scripts dynamically inside of a worker, Web Workers come with a handy API, ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope/importScripts"},["code",null,"importScript()"]],"."],"\n",["p",null,"Here's an example of how to use ",["code",null,"typescript"]," directly from a CDN with ",["code",null,"importScript()"],"."],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token function"},"importScripts"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"\"https://cdn.jsdelivr.net/npm/typescript@latest/lib/typescript.js\""],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["blockquote",null,"\n",["p",null,"Do not use ",["code",null,"importScript()"]," to import NPM dependencies you have installed using ",["code",null,"npm"]," or ",["code",null,"yarn"],". Use normal ES module imports as usual, so the bundler can understand it."],"\n"],"\n\n",["h3",{"id":"worker-callbacks"},"\n  ",["a",{"class":"heading-link","href":"#worker-callbacks"},["app-icon",{"name":"link"}],"\n  Worker Callbacks\n  "],"\n"],"\n",["p",null,"In most cases, waiting for a Promise to resolve with the output data is all we'll need. However, a limitation with native Promises is that it provides only one returned value. Where a traditional callback still shines is that it can be called numerous times with different data."],"\n",["p",null,"Let's say that we have a long running process that may take a few seconds to complete. With a Promise, we're unable to periodically receive the progress of the task, since all we can do is wait for Promise to resolve."],"\n",["p",null,"A feature with Stencil's worker is the ability to pass a callback to the method, and within the worker, execute the callback as much as it's needed before the task resolves."],"\n",["p",null,"In the example below, the task is given a number that it counts down from the number provided, and the task completes when it gets to ",["code",null,"0"],". During the count down, however, the main thread will still receive an update every second. This example will console log from ",["code",null,"5"]," to ",["code",null,"0"]],"\n",["p",null,["strong",null,"src/countdown.worker.ts:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"const"]," ",["span",{"class":"token function-variable function"},"countDown"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"("],"num",["span",{"class":"token operator"},":"]," ",["span",{"class":"token builtin"},"number"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token function-variable function"},"progress"],["span",{"class":"token operator"},":"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"p",["span",{"class":"token operator"},":"]," number"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token keyword"},"void"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token keyword"},"return"]," ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},["span",{"class":"token builtin"},"Promise"]],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"resolve"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," tmr ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token function"},"setInterval"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n      num",["span",{"class":"token operator"},"--"],["span",{"class":"token punctuation"},";"],"\n      ",["span",{"class":"token keyword"},"if"]," ",["span",{"class":"token punctuation"},"("],"num ",["span",{"class":"token operator"},">"]," ",["span",{"class":"token number"},"0"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n        ",["span",{"class":"token function"},"progress"],["span",{"class":"token punctuation"},"("],"num",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n      ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"else"]," ",["span",{"class":"token punctuation"},"{"],"\n        ",["span",{"class":"token function"},"clearInterval"],["span",{"class":"token punctuation"},"("],"tmr",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n        ",["span",{"class":"token function"},"resolve"],["span",{"class":"token punctuation"},"("],"num",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n      ",["span",{"class":"token punctuation"},"}"],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token number"},"1000"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,["strong",null,"src/my-app/my-app.tsx:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Component ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," countDown ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../countdown.worker'"],["span",{"class":"token punctuation"},";"],"\n\n@",["span",{"class":"token function"},"Component"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n  tag",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'my-cmp'"],"\n",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"class"]," ",["span",{"class":"token class-name"},"MyApp"]," ",["span",{"class":"token punctuation"},"{"],"\n\n  ",["span",{"class":"token function"},"componentWillLoad"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," startNum ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token number"},"5"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'start'"],["span",{"class":"token punctuation"},","]," startNum",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token function"},"countDown"],["span",{"class":"token punctuation"},"("],"startNum",["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"p"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'progress'"],["span",{"class":"token punctuation"},","]," p",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"then"],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"result"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n      ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'finish'"],["span",{"class":"token punctuation"},","]," result",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"When executed, the result would take 5 seconds and would log:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",null,["code",null,"start 5\nprogress 4\nprogress 3\nprogress 2\nprogress 1\nfinish 0"]],"\n  "],"\n      \n",["h2",{"id":"advanced-cases"},"\n  ",["a",{"class":"heading-link","href":"#advanced-cases"},["app-icon",{"name":"link"}],"\n  Advanced cases\n  "],"\n"],"\n",["p",null,"Sometimes it might be necessary to access the actual ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Worker"},["code",null,"Worker"]]," instance, because manual usage of the ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage"},["code",null,"postMessage()"]]," and ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope/onmessage"},["code",null,"onmessage"]]," is desired. However, there's still a tooling challenge in having to bundle the worker, and have the main bundle correctly reference the worker bundle url path. In that case, Stencil also has an API that exposes the worker directly so it can be used instead of the proxies mentioned early."],"\n",["p",null,"For a direct worker reference, add ",["code",null,"?worker"]," at the end of an ESM import. This virtual ES module will export:"],"\n",["ul",null,"\n",["li",null,["code",null,"worker"],": The actual Worker instance."],"\n",["li",null,["code",null,"workerPath"],": The path to the worker's entry-point (usually a path to a ",["code",null,".js"]," file)."],"\n",["li",null,["code",null,"workerName"],": The name of the worker, useful for debugging purposes."],"\n"],"\n",["p",null,["strong",null,"src/my-app/my-app.tsx:"]],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Component ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," sum ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../../stuff.worker'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token comment"},"// Using the ?worker query, allows to access the worker instance directly."],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," worker ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../../stuff.worker.ts?worker'"],["span",{"class":"token punctuation"},";"],"\n\n@",["span",{"class":"token function"},"Component"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n  tag",["span",{"class":"token operator"},":"]," ",["span",{"class":"token string"},"'my-cmp'"],"\n",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"class"]," ",["span",{"class":"token class-name"},"MyApp"]," ",["span",{"class":"token punctuation"},"{"],"\n\n  ",["span",{"class":"token function"},"componentWillLoad"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token comment"},"// Use worker api directly"],"\n    worker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"postMessage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"["],["span",{"class":"token string"},"'send data manually'"],["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token comment"},"// Use the proxy"],"\n    ",["span",{"class":"token keyword"},"const"]," result ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"sum"],["span",{"class":"token punctuation"},"("],["span",{"class":"token number"},"1"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token number"},"2"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token builtin"},"console"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"log"],["span",{"class":"token punctuation"},"("],"result",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]," ",["span",{"class":"token comment"},"// 3"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"You can even use this feature you create multiple Worker manually:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," workerPath ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../../stuff.worker.ts?worker'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"const"]," workerPool ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token punctuation"},"["],"\n  ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],"workerPath",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},","],"\n  ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],"workerPath",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},","],"\n  ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],"workerPath",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},","],"\n  ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],"workerPath",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},","],"\n",["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"In this example, we exclusively take advantage of the bundling performed by the compiler to obtain the ",["code",null,"workerPath"]," to the worker's entry point, then manually create a pool of workers."],"\n",["blockquote",null,"\n",["p",null,"Stencil will not instantiate a worker if it's unused, it takes advantage of tree-shaking to do this."],"\n"],"\n\n",["h4",{"id":"worker-termination"},"\n  ",["a",{"class":"heading-link","href":"#worker-termination"},["app-icon",{"name":"link"}],"\n  Worker Termination\n  "],"\n"],"\n",["p",null,"Any Web Workers can be terminated using the ",["a",{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Worker/terminate"},["code",null,"Worker.terminate()"]]," API, but since Stencil creates one worker shared across all the proxied methods, it's not recommended to terminate it manually. If you have a use-case for using ",["code",null,"terminate"]," and rebuilding workers, then we recommend using the ",["code",null,"workerPath"]," and creating a new Worker directly:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-tsx"},["code",{"class":"language-tsx"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," workerPath ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'../../stuff.worker.ts?worker'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"const"]," worker ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"Worker"],["span",{"class":"token punctuation"},"("],"workerPath",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token comment"},"// ..."],"\nworker",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"terminate"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]]],"\n  "]]}